#!/bin/bash

BUILD_DIR=$1

indent() {
  sed 's/^/       /'
}

LOGSTASH_VERSION=${LOGSTASH_VERSION:-9.0.2}

BUILDPACK_PATH=$(dirname $(readlink -f $0))/../

echo "Downloading Logstash version $LOGSTASH_VERSION" | indent

if [ ${LOGSTASH_VERSION:0:1} = "6" ]
then
  URL=https://artifacts.elastic.co/downloads/logstash/logstash-$LOGSTASH_VERSION.tar.gz
else
  URL=https://artifacts.elastic.co/downloads/logstash/logstash-oss-$LOGSTASH_VERSION-linux-x86_64.tar.gz
fi
curl $URL -L --silent -o /tmp/logstash.tar.gz

echo "Extracting logstash" | indent
tar -xf /tmp/logstash.tar.gz -C $BUILD_DIR

# Put user-provided config files aside:
if [ -d "${BUILD_DIR}/config" ]; then
  mv "${BUILD_DIR}/config" "${BUILD_DIR}/user_config" 2> /dev/null
fi

# Copy default config files:
mv "${BUILD_DIR}/logstash-${LOGSTASH_VERSION}/"* "${BUILD_DIR}/"
rmdir "${BUILD_DIR}/logstash-${LOGSTASH_VERSION}"

# Put back user-provided config:
if [ -d "${BUILD_DIR}/user_config" ]; then
  mv "${BUILD_DIR}/user_config/"* "${BUILD_DIR}/config/" 2> /dev/null
  rmdir "${BUILD_DIR}/user_config" 2> /dev/null
fi

export PATH="${PATH}:${BUILD_DIR}/bin"

# Hack : set java opts to half of available memory
mem_kb=$(awk '/MemTotal/ {print $2}' /proc/meminfo)
mem_mb=$((mem_kb / 1024))
heap_mb=$((mem_mb / 2))
if echo "${JAVA_OPTS:-}" | grep -q "\-Xms"; then
  export LS_JAVA_OPTS="$JAVA_OPTS"
else
  export LS_JAVA_OPTS="-Xmx${heap_mb}m -Xms${heap_mb}m $JAVA_OPTS"
fi

echo "LS_JAVA_OPTS=$LS_JAVA_OPTS" | indent

echo "Installing plugins" | indent

# Always install logstash-output-opensearch first
if [ -n "$LOGSTASH_PLUGINS" ]; then
  LOGSTASH_PLUGINS="logstash-output-opensearch,$LOGSTASH_PLUGINS"
else
  LOGSTASH_PLUGINS="logstash-output-opensearch"
fi

for plugin in $(echo $LOGSTASH_PLUGINS | sed "s/,/ /g") ; do
  start_time=$(date +%s)
  echo "Installing plugin $plugin" | indent
  logstash-plugin install "${plugin}" | indent
  end_time=$(date +%s)
  duration=$((end_time - start_time))
  echo "Plugin installation took ${duration} seconds" | indent
done

echo "Done" | indent
